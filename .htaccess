# PPV Streaming Platform - Apache Configuration

# Enable mod_rewrite
RewriteEngine On

# Force HTTPS (uncomment for production)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Security Headers
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

# Hide server information
ServerTokens Prod
Header unset Server
Header unset X-Powered-By

# Block access to sensitive files
<FilesMatch "\.(env|md|log|sql|htaccess|htpasswd|ini|conf|yaml|yml)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Block access to directories
RedirectMatch 404 ^/(vendor|src|config|database|tests)/.*$

# Prevent access to hidden files
<FilesMatch "^\.">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Route all requests through index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [QSA,L]

# Compress static files
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Set cache headers for static files
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
</IfModule>

# Limit request size (adjust as needed)
LimitRequestBody 52428800  # 50MB

# Rate limiting (requires mod_security or similar)
# <IfModule mod_security2.c>
#     SecRule IP:bf_counter "@gt 20" "phase:1,deny,status:429,setvar:ip.bf_counter=+1,expirevar:ip.bf_counter=3600"
# </IfModule>

# Block common attack patterns
RewriteCond %{QUERY_STRING} (eval\(|base64_decode|gzinflate|file_get_contents|fopen|fwrite) [NC]
RewriteRule ^(.*)$ - [F,L]

RewriteCond %{QUERY_STRING} (union.*select|select.*union|drop.*table|create.*table) [NC]
RewriteRule ^(.*)$ - [F,L]

RewriteCond %{QUERY_STRING} (<script>|</script>|javascript:|onload=|onclick=) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block user agents (bots, scanners)
RewriteCond %{HTTP_USER_AGENT} (Nmap|sqlmap|nikto|w3af|Acunetix|Burp|Paros) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block requests with no user agent
RewriteCond %{HTTP_USER_AGENT} ^$ [NC]
RewriteRule ^(.*)$ - [F,L]

# PHP security settings (if .htaccess can override php.ini)
<IfModule mod_php.c>
    php_flag display_errors off
    php_flag log_errors on
    php_flag expose_php off
    php_value session.cookie_httponly 1
    php_value session.cookie_secure 1
    php_value session.use_strict_mode 1
</IfModule>